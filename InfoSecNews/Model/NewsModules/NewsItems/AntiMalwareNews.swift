//
//  AntiMalwareNews.swift
//  InfoSecNews
//
//  Created by Roman Zheglov on 08.03.2025.
//

import Foundation
import SwiftSoup

final class AntiMalwareNews: NewsBehavior {
    var source: String
    var title: String
    var date: Date
    var short: String
    var fullTextLink: URL
    var full: String?
    
    init(source: String, title: String, date: Date, short: String, fullTextLink: URL, full: String? = nil) {
        self.source = source
        self.title = title
        self.date = date
        self.short = short
        self.fullTextLink = fullTextLink
    }
    
    func loadRemoteData(voyager: WebVoyager) async throws {
        
        let input = await voyager.fetch(url: fullTextLink)
        
        switch input {
        case .success(let html):
            parseFullArticle(html: html)
        case .failure(let failure):
            throw failure
        }
    }
    
    private func parseFullArticle(html: String) {
        
        let htDoc = try! SwiftSoup.parse(html)
        
        if let full = try? htDoc.select(".field-type-text-with-summary .field-item").first() {
            var innerText = ""
            for item in full.children() {
                if let blockText = try? item.text(),
                   !blockText.trimmingCharacters(in: .whitespacesAndNewlines).isEmpty
                {
                    innerText += blockText
                    innerText += "\n\n"
                }
            }
            self.full = innerText.trimmingCharacters(in: ["\n"])
            return
        }
    }
}
